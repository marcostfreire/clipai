# ClipAI â€“ AI Agent Working Notes

- **Architecture**: FastAPI API + Celery worker + PostgreSQL + Redis broker; video assets in local `storage/videos` or Cloudflare R2 (see [backend/app/config.py](../backend/app/config.py), [backend/app/main.py](../backend/app/main.py), [backend/app/tasks/celery_tasks.py](../backend/app/tasks/celery_tasks.py)). Frontend is Next.js 16 (App Router) with an edge proxy to the backend (see [frontend/app/api/proxy/[...path]/route.ts](../frontend/app/api/proxy/[...path]/route.ts)).
- **Core models**: `User`, `Video`, `Clip` with cascade delete on clips (see [backend/app/models.py](../backend/app/models.py)). Videos track `status`, `progress`, `error_message`; clips store file/thumbnail paths and analysis data.
- **Upload flow**: POST `/api/videos/upload` accepts file or YouTube URL; validates extensions and plan limits, stores under `storage_path/{video_id}` (or uploads to R2), records size/duration, and returns `video_id` queued (see [backend/app/api/videos.py](../backend/app/api/videos.py)). Large uploads use chunk endpoints `/upload/chunk` + `/upload/complete`.
- **Processing flow**: POST `/api/videos/{id}/process` enqueues Celery `process_video_task`; worker updates DB progress and task state (see [backend/app/tasks/celery_tasks.py](../backend/app/tasks/celery_tasks.py)). Pipeline in [backend/app/services/video_processor.py](../backend/app/services/video_processor.py): extract frames (fps=0.1), Gemini visual analysis with frame dedupe, Whisper transcription, Gemini viral moment detection, segment selection (min/max duration, sentence boundaries), per-clip face-aware crop -> vertical convert -> ASS subtitles -> thumbnail. Default clip score threshold set by settings.
- **Media services**: FFmpeg wrapper for probe/cut/vertical/subtitles/thumbnails (see [backend/app/services/ffmpeg_service.py](../backend/app/services/ffmpeg_service.py)); Whisper via `faster-whisper` with word timestamps (see [backend/app/services/whisper_service.py](../backend/app/services/whisper_service.py)); Gemini client with retry + JSON parsing and deduped frame batches (see [backend/app/services/gemini_service.py](../backend/app/services/gemini_service.py)).
- **Storage**: `StorageService` handles local vs Cloudflare R2, presigned redirects for clip download/thumbnail, and local cleanup; use `get_storage_service()` instead of instantiating directly (see [backend/app/services/storage_service.py](../backend/app/services/storage_service.py)).
- **Auth**: JWT bearer stored in localStorage; optional Google OAuth (see [backend/app/api/auth.py](../backend/app/api/auth.py) and [frontend/app/auth/callback/page.tsx](../frontend/app/auth/callback/page.tsx)). Use `get_current_user`/`get_current_user_optional` dependencies (see [backend/app/services/auth_service.py](../backend/app/services/auth_service.py)).
- **Subscriptions**: Plan limits and price IDs are hard-coded in [backend/app/services/subscription_service.py](../backend/app/services/subscription_service.py); enforcement happens in upload (HTTP 402 with `subscription_limit_reached`) and `/subscriptions/limits` surfaces usage/reset info. Stripe webhooks update `subscription_tier/status` (see [backend/app/api/webhooks.py](../backend/app/api/webhooks.py)).
- **Frontend patterns**: API client uses Axios with aggressive retry and optional edge proxy; JWT auto-attached from localStorage (see [frontend/lib/api.ts](../frontend/lib/api.ts)). State in Zustand ([frontend/lib/store.ts](../frontend/lib/store.ts)). Uploader does 4MB chunking, enforces limits, and shows paywall modal (see [frontend/components/video-uploader.tsx](../frontend/components/video-uploader.tsx), [frontend/components/paywall-modal.tsx](../frontend/components/paywall-modal.tsx)). Processing page polls `/videos/{id}/status` then lists clips (see [frontend/app/videos/[id]/page.tsx](../frontend/app/videos/[id]/page.tsx), [frontend/components/processing-status.tsx](../frontend/components/processing-status.tsx), [frontend/components/clip-card.tsx](../frontend/components/clip-card.tsx)).
- **Endpoints of interest**: `/api/videos/upload` (file/URL/chunk), `/api/videos/{id}/process`, `/api/videos/{id}/status`, `/api/videos/{id}/clips`, `/api/clips/{clip_id}/download|thumbnail`, `/api/subscriptions/*`, `/api/webhooks/stripe`, `/health/*`.
- **Config defaults**: See [backend/app/config.py](../backend/app/config.py) for environment keys. Important: `GOOGLE_API_KEY`, `DATABASE_URL`, `REDIS_URL`, `STORAGE_PATH`, `GEMINI_MODEL_DEFAULT/STRICT`, `WHISPER_MODEL/DEVICE/COMPUTE_TYPE`, `FFMPEG_PRESET/CRF/AUDIO_BITRATE`, Stripe secrets/price IDs, R2 credentials, `CORS_ORIGINS`, `JWT_SECRET`.
- **Dev workflow**: Local API `uvicorn app.main:app --reload`; worker `celery -A app.tasks.celery_tasks worker --loglevel=info --concurrency=1 --pool=solo`; Docker compose brings Postgres/Redis/API/worker/frontend (see root [docker-compose.dev.yml](../docker-compose.dev.yml)). Ensure `storage_path` exists on startup.
- **Testing**: Backend tests in [backend/tests](../backend/tests) using pytest + httpx; commands in [backend/tests/README.md](../backend/tests/README.md) (target coverage 80%+, sample ffmpeg mocks). Frontend: `npm install`, `npm run lint`, `npx tsc --noEmit`, `npm run build` (see [frontend/package.json](../frontend/package.json)).
- **Operational limits**: Celery tasks time out hard at 3600s; worker concurrency/prefetch fixed at 1; upload size limit 500MB and duration limits depend on plan; YouTube URL flow rejects >200MB or >20min before download.
- **Health/CORS**: `/health/cors` endpoint echoes headers to debug CORS; global CORS origins from env `cors_origins` (comma-separated or `*`). Edge proxy sets permissive CORS/headers for Railway backend.
- **Deletion/cleanup**: Deleting a video removes files and cascades clips; `cleanup_old_videos_task` removes local files older than configurable days.
- **When adding features**: Reuse `get_storage_service()` for file paths, update plan limits/price IDs together (subscription service + pricing UI), surface progress via Celery `update_state`, and keep subtitles in ASS format via ffmpeg service helpers.
